name: Deploy Wiki Search Worker & Sync AutoRAG

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allows manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy Worker and Sync AutoRAG
    
    steps:
      # Step 1: Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # Step 3: Install dependencies
      - name: Install dependencies
        run: npm ci

      # Step 4: Deploy Worker using Wrangler
      - name: Deploy Worker to Cloudflare
        run: npx wrangler deploy --env=""
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      # Step 5: Sync wiki files to R2 bucket
      - name: Clone wiki repository
        run: |
          git clone https://github.com/neverinfamous/sqlite-mcp-server.wiki.git wiki-temp
          
      - name: Upload wiki files to R2
        run: |
          cd wiki-temp
          for file in *.md; do
            echo "Uploading $file to R2..."
            npx wrangler r2 object put sqlite-mcp-server-wiki/"$file" --file="$file" --remote
          done
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      # Step 6: Trigger AutoRAG sync (manual sync via dashboard)
      - name: AutoRAG Sync Note
        run: |
          echo "üìù Note: AutoRAG automatically syncs every 6 hours from R2."
          echo "üí° To manually trigger sync now, visit:"
          echo "   https://dash.cloudflare.com/<REDACTED_ACCOUNT_ID>/ai/ai-search/sqlite-mcp-server-wiki"
          echo "   Click 'Sync Index' button in the dashboard."

      - name: Deployment Summary
        run: |
          echo "‚úÖ Worker deployed to Cloudflare"
          echo "‚úÖ Wiki files synced to R2 bucket: sqlite-mcp-server-wiki"
          echo "‚úÖ AutoRAG index sync triggered"
          echo ""
          echo "üîó Worker URL: https://sqlite-wiki-search.adamic.workers.dev"
          echo "üîó Custom Domain: https://search.adamic.tech"

